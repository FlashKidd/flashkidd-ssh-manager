#!/usr/bin/env bash
set -euo pipefail

SCRIPT_PATH="${BASH_SOURCE[0]:-$0}"
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
# shellcheck disable=SC1090
source "$SCRIPT_DIR/fk-settings.sh"

fk_common_init "$@"
set -- "${FK_ARGS[@]}"

fk_require_root
fk_load_env

CHILD_COLOR_ARGS=()
if [[ ${FK_COLOR_OFF:-0} -eq 1 ]]; then
    CHILD_COLOR_ARGS+=(--no-color)
elif [[ ${FK_COLOR_FORCED:-0} -eq 1 || ${FK_COLOR:-0} -eq 1 ]]; then
    CHILD_COLOR_ARGS+=(--color)
fi
JUST_PRINTED_BANNER=0

show_menu() {
    local skip="${1:-0}"
    if [[ "$skip" -eq 0 ]]; then
        fk_banner
    fi
    cat <<'MENU'
1) Create SSH user
2) Create Trial user
3) Renew / Extend SSH user
4) Delete SSH user
5) Show online users
6) V2Ray (vmess/vless/ws)
7) OpenVPN / WireGuard
8) Per-user throttle
9) Port Manager (safe rollback)
10) Payload generator
11) Recon suite
12) Backup / Restore
13) Custom banner / MOTD
14) System dashboard
15) Logs & sessions
16) Settings / Security
0) Exit
MENU
}

while true; do
    show_menu "$JUST_PRINTED_BANNER"
    JUST_PRINTED_BANNER=0
    read -rp 'Select option: ' choice
    case "$choice" in
        1)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-user-add.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        2)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-user-trial.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        3)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-user-renew.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        4)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-user-del.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        5)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-users-online.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        6)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-v2ray-menu.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        7)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-vpn-menu.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        8)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-throttle.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        9)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-port-manager.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        10)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-payloads.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        11)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-recon.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        12)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-backup.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        13)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-banner.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        14)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-dashboard.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        15)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-logs.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        16)
            FK_POST_ACTION_BANNER=0
            "$SCRIPT_DIR/fk-settings.sh" "${CHILD_COLOR_ARGS[@]}"
            JUST_PRINTED_BANNER=${FK_POST_ACTION_BANNER:-0}
            ;;
        0)
            printf 'Goodbye!\n'
            exit 0
            ;;
        *)
            printf 'Invalid option.\n'
            sleep 1
            JUST_PRINTED_BANNER=0
            ;;
    esac
done
